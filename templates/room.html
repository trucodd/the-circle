<!DOCTYPE html>
<html>
<head>
    <title>Circle Room - Live Translator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .meeting-area { display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
        .main-area { background: white; padding: 20px; border-radius: 10px; }
        .sidebar { background: white; padding: 20px; border-radius: 10px; }
        .chat-section { margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .chat-messages { height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; margin: 8px 0; background: white; border-radius: 5px; }
        .chat-message { margin: 5px 0; padding: 8px; border-radius: 5px; }
        .chat-message.own { background: #007bff; color: white; margin-left: 20px; }
        .chat-message.other { background: #e9ecef; margin-right: 20px; }
        .chat-input { display: flex; gap: 10px; margin-top: 10px; }
        .chat-input input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .typing-indicator { font-style: italic; color: #666; font-size: 12px; padding: 5px; min-height: 20px; }
        .controls { margin: 20px 0; text-align: center; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .record-btn { background: #dc3545; color: white; }
        .record-btn.recording { background: #28a745; }
        .stop-btn { background: #6c757d; color: white; }
        .messages { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin: 20px 0; }
        .message { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .user-list { list-style: none; padding: 0; }
        .user-item { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; }
        .status { text-align: center; margin: 20px 0; padding: 10px; background: #d4edda; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåç Circle Room: {{ room_id }}</h1>
        <p>Real-time voice translation active</p>
    </div>

    <div class="meeting-area">
        <div class="main-area">
            <div class="status" id="status">
                Connecting to circle...
            </div>

            <div class="controls">
                <button id="recordBtn" class="record-btn" onclick="toggleRecording()">
                    üé§ Start Speaking
                </button>
                <button class="stop-btn" onclick="stopRecording()">
                    ‚èπÔ∏è Stop
                </button>

            </div>

            <div class="messages" id="messages">
                <div class="message">
                    <strong>System:</strong> Welcome! Speak in your language and others will hear it translated.
                </div>
            </div>

            <div class="chat-section">
                <h4>üí¨ Text Chat</h4>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message other">
                        <strong>System:</strong> Chat is ready! Send messages to all participants.
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator"></div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type a message..." maxlength="500">
                    <button onclick="sendChatMessage()" style="background: #007bff; color: white;">Send</button>
                </div>
            </div>


            
            <div style="text-align: center; margin: 20px 0;">
                <p><strong>How it works:</strong></p>
                <p>1. Speak naturally 2. Get live translation 3. Chat in real-time 4. Voice dubbing across languages</p>
            </div>
        </div>

        <div class="sidebar">
            <h3>üë• Participants</h3>
            <ul class="user-list" id="userList">
            </ul>

            <h3>‚öôÔ∏è Settings</h3>
            <p><strong>Your Language:</strong> <span id="userLang"></span></p>
            <p><strong>Room ID:</strong> {{ room_id }}</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || 'Anonymous';
        const language = urlParams.get('language') || 'en';
        const roomId = '{{ room_id }}';

        document.getElementById('userLang').textContent = language.toUpperCase();

        const socket = io();
        let mediaRecorder;
        let isRecording = false;
        let typingTimer;
        let isTyping = false;

        // Join circle
        socket.emit('join_circle', {
            room_id: roomId,
            username: username,
            language: language
        });

        // Handle user joined
        socket.on('user_joined', function(data) {
            document.getElementById('status').innerHTML = `‚úÖ Connected! ${data.users.length} participants`;
            updateUserList(data.users);
            addMessage('System', `${data.username} joined (${data.language.toUpperCase()})`);
        });

        // Handle user left
        socket.on('user_left', function(data) {
            document.getElementById('status').innerHTML = `‚úÖ Connected! ${data.users.length} participants`;
            updateUserList(data.users);
        });

        // Handle live transcription
        socket.on('transcript_update', function(data) {
            const time = new Date(data.timestamp * 1000).toLocaleTimeString();
            addMessage(`${data.speaker} (${time})`, data.text);
        });

        // Handle voice messages (original only)
        socket.on('voice_message', function(data) {
            const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isOwnMessage = data.speaker === username;
            const dubButton = isOwnMessage ? '' : `<button onclick="requestDub('${data.message_id}', '${data.audio_data}', '${data.speaker}', '${data.source_language}')" style="background: #28a745; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px; font-size: 12px;">üéØ Dub</button>`;
            
            // Store audio data globally for playback
            window.audioMessages = window.audioMessages || {};
            window.audioMessages[data.message_id] = data.audio_data;
            
            addMessage(`üéôÔ∏è ${data.speaker}`, `Voice message (${time}) <button onclick="playVoiceMessage('${data.message_id}')" style="background: #007bff; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">‚ñ∂Ô∏è Play</button>${dubButton}`);
        });
        
        // Handle translated audio from dubbing API
        socket.on('translated_audio', function(data) {
            if (data.audio_data) {
                const playButton = `<button onclick="playAudio('data:audio/wav;base64,${data.audio_data}')" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">‚ñ∂Ô∏è Play Dubbed</button>`;
                addMessage(`üéØ ${data.speaker} (Dubbed)`, `Voice translated to your language ${playButton}`);
            }
        });
        
        // Handle fast translated audio (2-3 seconds)
        socket.on('fast_translated_audio', function(data) {
            addMessage(`üéôÔ∏è ${data.speaker} (translated)`, `"${data.translated_text}"`);
            
            // Play TTS audio directly
            if (data.audio_data) {
                const audio = new Audio('data:audio/wav;base64,' + data.audio_data);
                audio.volume = 0.8;
                audio.play().catch(e => console.log('Fast audio play failed:', e));
            }
        });
        
        // Function to play voice message
        function playVoiceMessage(messageId) {
            const audioData = window.audioMessages[messageId];
            if (audioData) {
                const audio = new Audio('data:audio/wav;base64,' + audioData);
                audio.play();
            }
        }
        
        // Function to play dubbed audio
        function playAudio(audioSrc) {
            const audio = new Audio(audioSrc);
            audio.volume = 0.8;
            audio.play().catch(e => console.log('Audio play failed:', e));
        }
        
        // Function to request dubbing
        function requestDub(messageId, audioData, speakerName, sourceLanguage) {
            addMessage('System', `üîÑ Requesting translation for ${speakerName}'s message...`);
            
            socket.emit('request_dub', {
                message_id: messageId,
                target_language: language,
                audio_data: audioData,
                speaker_name: speakerName,
                source_language: sourceLanguage
            });
        }
        
        // Handle dubbing errors
        socket.on('dubbing_error', function(data) {
            addMessage('System', `‚ùå Translation Error: ${data.error}`);
        });
        
        // Handle dubbing status updates
        socket.on('dubbing_status', function(data) {
            if (data.status === 'processing') {
                addMessage('System', `üîÑ ${data.message}`);
            } else if (data.status === 'queued') {
                addMessage('System', `‚è≥ ${data.message}`);
            }
        });

        // Chat event handlers
        socket.on('chat_history', function(data) {
            const chatMessages = document.getElementById('chatMessages');
            data.messages.forEach(msg => {
                addChatMessage(msg);
            });
        });

        socket.on('new_message', function(message) {
            addChatMessage(message);
        });

        socket.on('user_typing', function(data) {
            const typingIndicator = document.getElementById('typingIndicator');
            if (data.typing) {
                typingIndicator.textContent = `${data.username} is typing...`;
            } else {
                typingIndicator.textContent = '';
            }
        });

        socket.on('error', function(data) {
            addMessage('System', `‚ùå ${data.message}`);
        });

        function updateUserList(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-item';
                li.innerHTML = `${user.username} <small>(${user.language.toUpperCase()})</small>`;
                userList.appendChild(li);
            });
        }

        function addMessage(sender, message) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `<strong>${sender}:</strong> ${message}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        async function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                const audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    const reader = new FileReader();
                    reader.onload = function() {
                        const audioData = reader.result.split(',')[1];
                        
                        socket.emit('audio_data', {
                            room_id: roomId,
                            username: username,
                            audio: audioData,
                            source_language: language
                        });
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    addMessage('You', 'Voice message sent');
                };

                mediaRecorder.start();
                isRecording = true;
                
                const btn = document.getElementById('recordBtn');
                btn.textContent = 'üî¥ Recording...';
                btn.className = 'record-btn recording';
                
            } catch (err) {
                alert('Microphone access required');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                const btn = document.getElementById('recordBtn');
                btn.textContent = 'üé§ Start Speaking';
                btn.className = 'record-btn';
            }
        }



        // Chat functions
        function addChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const div = document.createElement('div');
            const isOwnMessage = message.username === username;
            
            div.className = `chat-message ${isOwnMessage ? 'own' : 'other'}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (isOwnMessage) {
                div.innerHTML = `<div>${message.message}</div><small>${time}</small>`;
            } else {
                div.innerHTML = `<strong>${message.username}:</strong> ${message.message} <small>(${time})</small>`;
            }
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendChatMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                socket.emit('send_message', {
                    message: message
                });
                messageInput.value = '';
                
                // Stop typing indicator
                if (isTyping) {
                    socket.emit('typing', { typing: false });
                    isTyping = false;
                }
            }
        }

        // Handle Enter key in chat input
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Handle typing indicator
        document.getElementById('messageInput').addEventListener('input', function() {
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing', { typing: true });
            }
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (isTyping) {
                    socket.emit('typing', { typing: false });
                    isTyping = false;
                }
            }, 1000);
        });
    </script>
</body>
</html>