<!DOCTYPE html>
<html>
<head>
    <title>{{ room_name }} - The Circle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#000000',
                        'dark-card': '#1c1c1e',
                        'dark-surface': '#2c2c2e',
                        'dark-border': '#3a3a3c'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .glass-effect {
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .message-bubble {
            background: #3b82f6/20;
            border: 1px solid #3b82f6/30;
        }
        .message-bubble.own {
            background: #10b981/20;
            border: 1px solid #10b981/30;
        }
        .message-bubble.voice {
            background: #f59e0b/20;
            border: 1px solid #f59e0b/30;
        }
        .message-bubble.voice.own {
            background: #8b5cf6/20;
            border: 1px solid #8b5cf6/30;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>

<body class="bg-dark-bg h-screen text-gray-100 font-sans overflow-hidden">
    <!-- Chat Container -->
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="glass-effect px-4 py-3 border-b border-white/10">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <!-- Circle Avatar -->
                    <div id="circleAvatar" class="w-12 h-12 rounded-2xl bg-gray-700 flex items-center justify-center text-xl overflow-hidden">
                        {{ circle_emoji }}
                    </div>
                    
                    <!-- Chat Info -->
                    <div>
                        <h2 onclick="copyCircleId()" class="text-lg font-bold text-white cursor-pointer hover:text-gray-300 transition-colors" title="Tap to copy Circle ID">
                            {{ room_id }}
                        </h2>
                        <p class="text-sm text-gray-400">
                            <span id="participantCount">1</span> participants
                        </p>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center space-x-2">
                    <select id="circleLanguage" onchange="setCircleLanguage()" 
                            class="px-3 py-1 rounded-lg bg-white/10 border border-white/20 text-white text-sm focus:border-white/40 transition-all">
                        <option value="en" class="bg-dark-card">🇺🇸 EN</option>
                        <option value="es" class="bg-dark-card">🇪🇸 ES</option>
                        <option value="fr" class="bg-dark-card">🇫🇷 FR</option>
                        <option value="de" class="bg-dark-card">🇩🇪 DE</option>
                        <option value="ja" class="bg-dark-card">🇯🇵 JA</option>
                        <option value="hi" class="bg-dark-card">🇮🇳 HI</option>
                    </select>
                    
                    <button onclick="leaveCircle()" 
                            class="px-4 py-2 rounded-xl bg-red-600/20 text-red-400 hover:bg-red-600/30 transition-all duration-300">
                        Leave
                    </button>
                    <button onclick="window.location.href='/dashboard'" 
                            class="px-4 py-2 rounded-xl bg-white/10 text-gray-300 hover:bg-white/20 transition-all duration-300">
                        ← Back
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Messages Area -->
        <div id="messagesArea" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Welcome Message -->
            <div class="text-center py-4">
                <div class="inline-block px-6 py-3 rounded-2xl bg-white/10 text-gray-300 text-sm">
                    Welcome to {{ room_name }}! Start chatting with voice or text.
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="px-4 py-2 text-sm text-gray-400 italic min-h-[2rem]"></div>

        <!-- Input Area -->
        <div class="glass-effect p-4 border-t border-white/10">
            <div class="flex items-end space-x-3 bg-white/10 rounded-3xl p-2">
                <textarea 
                    id="messageInput" 
                    placeholder="Type a message..." 
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                    oninput="handleTyping()"
                    class="flex-1 bg-transparent border-none text-white placeholder-gray-400 resize-none outline-none px-4 py-2 max-h-32"
                ></textarea>
                
                <div class="flex space-x-2">
                    <button id="voiceBtn" onclick="toggleVoiceRecording()" 
                            class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center text-gray-300 transition-all duration-300">
                        <img src="https://api.iconify.design/mdi:microphone.svg?color=white" alt="Microphone" class="w-5 h-5">
                    </button>
                    <button onclick="sendMessage()" 
                            class="w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-white transition-all duration-300">
                        ➤
                    </button>
                    <button onclick="leaveCircle()" 
                            class="sm:hidden w-10 h-10 rounded-full bg-red-600/20 hover:bg-red-600/30 flex items-center justify-center text-red-400 transition-all duration-300" 
                            title="Leave Circle">
                        ✕
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username') || 'Anonymous';
        const userLanguage = localStorage.getItem('userLanguage') || 'en';
        const roomId = '{{ room_id }}';
        const circleColor = '{{ circle_color }}' || '#64ffda';

        document.documentElement.style.setProperty('--circle-color', circleColor);
        

        const socket = io();
        let mediaRecorder;
        let isRecording = false;
        let typingTimer;
        let isTyping = false;

        // Set initial circle language
        document.getElementById('circleLanguage').value = userLanguage;
        
        // Join circle
        socket.emit('join_circle', {
            room_id: roomId,
            username: username,
            language: userLanguage
        });
        
        function setCircleLanguage() {
            const language = document.getElementById('circleLanguage').value;
            socket.emit('set_circle_language', { language: language });
        }

        // Socket event handlers
        socket.on('user_joined', function(data) {
            document.getElementById('participantCount').textContent = data.users.length;
            addStatusMessage(`${data.username} joined the circle`);
        });

        socket.on('user_left', function(data) {
            document.getElementById('participantCount').textContent = data.users.length;
        });

        socket.on('new_message', function(message) {
            addTextMessage(message);
        });

        socket.on('voice_message', function(data) {
            addVoiceMessage(data);
        });

        socket.on('translated_audio', function(data) {
            updateVoiceMessageWithDub(data);
        });

        socket.on('user_typing', function(data) {
            showTypingIndicator(data.username, data.typing);
        });

        socket.on('dubbing_status', function(data) {
            // Only show status for requested dubs
        });

        socket.on('dubbing_error', function(data) {
            // Reset dub button on error
            const dubBtns = document.querySelectorAll('.dub-btn');
            dubBtns.forEach(btn => {
                if (btn.textContent.includes('Dubbing')) {
                    btn.textContent = '🌍 Dub';
                    btn.disabled = false;
                }
            });
            addStatusMessage(`❌ Translation failed: ${data.error}`);
        });

        function addTextMessage(message) {
            const messagesArea = document.getElementById('messagesArea');
            const isOwn = message.username === username;
            const currentCircleLanguage = document.getElementById('circleLanguage').value;
            const needsTranslation = !isOwn && message.language && message.language !== currentCircleLanguage;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} mb-4`;
            messageDiv.setAttribute('data-message-id', message.id);
            
            const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="flex items-end space-x-2 max-w-xs lg:max-w-md ${isOwn ? 'flex-row-reverse space-x-reverse' : ''}">
                    ${!isOwn ? `<div onclick="viewUserProfile('${message.username}')" class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold text-white flex-shrink-0 cursor-pointer hover:bg-gray-500 transition-colors">${message.username.charAt(0).toUpperCase()}</div>` : ''}
                    <div class="message-bubble rounded-2xl px-4 py-2 ${isOwn ? 'own' : ''}">
                        ${!isOwn ? `<div class="text-xs font-semibold text-gray-300 mb-1">${message.username}</div>` : ''}
                        <div class="text-white original-text">${message.message}</div>
                        ${needsTranslation ? `
                            <div class="mt-2 flex items-center gap-2">
                                <button onclick="translateMessage('${message.id}', '${message.message.replace(/'/g, "\\'").replace(/"/g, '\\"')}', '${message.language}')" class="text-xs px-2 py-1 rounded-lg bg-blue-600 hover:bg-blue-500 text-white transition-all duration-300 flex items-center gap-1">
                                    <img src="https://api.iconify.design/mdi:translate.svg?color=white" alt="Translate" class="w-3 h-3"> Translate
                                </button>
                            </div>
                        ` : ''}
                        <div class="text-xs text-gray-400 mt-1">${time}</div>
                    </div>
                    ${isOwn ? `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold text-white flex-shrink-0">${username.charAt(0).toUpperCase()}</div>` : ''}
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function addVoiceMessage(data) {
            const messagesArea = document.getElementById('messagesArea');
            const isOwn = data.speaker === username;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} mb-4`;
            
            const time = new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const audioId = 'audio_' + Date.now();
            
            const langName = {
                'en': 'English', 'es': 'Spanish', 'fr': 'French', 
                'ja': 'Japanese', 'hi': 'Hindi'
            }[data.language] || data.language.toUpperCase();
            
            messageDiv.innerHTML = `
                <div class="flex items-end space-x-2 max-w-xs lg:max-w-md ${isOwn ? 'flex-row-reverse space-x-reverse' : ''}">
                    ${!isOwn ? `<div onclick="viewUserProfile('${data.speaker}')" class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold text-white flex-shrink-0 cursor-pointer hover:bg-gray-500 transition-colors">${data.speaker.charAt(0).toUpperCase()}</div>` : ''}
                    <div class="message-bubble voice rounded-2xl px-4 py-3 ${isOwn ? 'own' : ''}">
                        ${!isOwn ? `<div class="text-xs font-semibold text-gray-300 mb-2">${data.speaker}</div>` : ''}
                        <div class="flex items-center space-x-3">
                            <button onclick="playAudio('${audioId}')" class="w-8 h-8 rounded-full bg-gray-600 hover:bg-gray-500 flex items-center justify-center text-white transition-all duration-300">
                                <img src="https://api.iconify.design/mdi:play.svg?color=white" alt="Play" class="w-4 h-4">
                            </button>
                            <div class="flex-1">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300 flex items-center gap-1"><img src="https://api.iconify.design/mdi:waveform.svg?color=white" alt="Audio" class="w-4 h-4"> ${langName}</span>
                                    ${!isOwn ? `<button onclick="requestDub('${data.message_id}', '${data.audio_data}', '${data.speaker}', '${data.language}')" class="text-xs px-2 py-1 rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-all duration-300 flex items-center gap-1"><img src="https://api.iconify.design/mdi:translate.svg?color=white" alt="Translate" class="w-3 h-3"> Dub</button>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">${time}</div>
                        <audio id="${audioId}" style="display: none;">
                            <source src="data:audio/webm;base64,${data.audio_data}" type="audio/webm">
                            <source src="data:audio/wav;base64,${data.audio_data}" type="audio/wav">
                        </audio>
                    </div>
                    ${isOwn ? `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold text-white flex-shrink-0">${username.charAt(0).toUpperCase()}</div>` : ''}
                </div>
            `;
            
            messageDiv.setAttribute('data-message-id', data.message_id);
            
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function addTranslatedVoiceMessage(data) {
            const messagesArea = document.getElementById('messagesArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-start mb-4';
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const audioId = 'translated_audio_' + Date.now();
            
            messageDiv.innerHTML = `
                <div class="flex items-end space-x-2 max-w-xs lg:max-w-md">
                    <div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center text-xs font-bold text-white flex-shrink-0">${data.speaker.charAt(0).toUpperCase()}</div>
                    <div class="message-bubble rounded-2xl px-4 py-3">
                        <div class="text-xs font-semibold text-gray-300 mb-2">${data.speaker} (translated)</div>
                        <div class="flex items-center space-x-3">
                            <button onclick="playAudio('${audioId}')" class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-white transition-all duration-300">
                                ▶️
                            </button>
                            <span class="text-sm text-gray-300">🌍 Translated voice</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-2">${time}</div>
                        <audio id="${audioId}" style="display: none;">
                            <source src="data:audio/webm;base64,${data.audio_data}" type="audio/webm">
                            <source src="data:audio/wav;base64,${data.audio_data}" type="audio/wav">
                        </audio>
                    </div>
                </div>
            `;
            
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }

        function addStatusMessage(text) {
            const messagesArea = document.getElementById('messagesArea');
            const statusDiv = document.createElement('div');
            statusDiv.className = 'text-center py-2';
            statusDiv.innerHTML = `<div class="inline-block px-4 py-2 rounded-2xl bg-white/10 text-gray-400 text-sm">${text}</div>`;
            messagesArea.appendChild(statusDiv);
            scrollToBottom();
        }

        function playAudio(audioId) {
            const audio = document.getElementById(audioId);
            if (audio) {
                audio.volume = 0.8;
                audio.play().catch(e => console.log('Audio play failed:', e));
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                socket.emit('send_message', { message: message });
                input.value = '';
                adjustTextareaHeight();
                
                if (isTyping) {
                    socket.emit('typing', { typing: false });
                    isTyping = false;
                }
            }
        }

        async function toggleVoiceRecording() {
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    const audioChunks = [];
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        const reader = new FileReader();
                        reader.onload = function() {
                            const audioData = reader.result.split(',')[1];
                            
                            socket.emit('audio_data', {
                                room_id: roomId,
                                username: username,
                                audio: audioData,
                                source_language: userLanguage
                            });
                        };
                        reader.readAsDataURL(audioBlob);
                        
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    voiceBtn.innerHTML = '<img src="https://api.iconify.design/mdi:stop.svg?color=white" alt="Stop" class="w-5 h-5">';
                    voiceBtn.classList.add('pulse');
                    
                } catch (err) {
                    alert('Microphone access required for voice messages');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.innerHTML = '<img src="https://api.iconify.design/mdi:microphone.svg?color=white" alt="Microphone" class="w-5 h-5">';
                voiceBtn.classList.remove('pulse');
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleTyping() {
            adjustTextareaHeight();
            
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing', { typing: true });
            }
            
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (isTyping) {
                    socket.emit('typing', { typing: false });
                    isTyping = false;
                }
            }, 1000);
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function showTypingIndicator(username, typing) {
            const indicator = document.getElementById('typingIndicator');
            if (typing) {
                indicator.textContent = `${username} is typing...`;
            } else {
                indicator.textContent = '';
            }
        }

        function requestDub(messageId, audioData, speakerName, sourceLanguage) {
            const currentCircleLanguage = document.getElementById('circleLanguage').value;
            if (currentCircleLanguage === sourceLanguage) {
                alert('This message is already in your preferred language');
                return;
            }
            
            // Show loading state
            const dubBtn = event.target;
            const originalText = dubBtn.textContent;
            dubBtn.textContent = '⏳ Dubbing...';
            dubBtn.disabled = true;
            
            socket.emit('request_dub', {
                message_id: messageId,
                audio_data: audioData,
                speaker_name: speakerName,
                source_language: sourceLanguage
            });
        }
        
        function updateVoiceMessageWithDub(data) {
            const messageDiv = document.querySelector(`[data-message-id="${data.message_id}"]`);
            if (messageDiv) {
                const audioId = 'dubbed_' + Date.now();
                const dubAudio = `<audio id="${audioId}" style="display: none;"><source src="data:audio/wav;base64,${data.audio_data}" type="audio/wav"></audio>`;
                
                // Add dubbed audio to message
                messageDiv.innerHTML += dubAudio;
                
                // Find and replace dub button
                const dubBtn = messageDiv.querySelector('button[onclick*="requestDub"]');
                if (dubBtn) {
                    dubBtn.onclick = () => playAudio(audioId);
                    dubBtn.innerHTML = '<img src="https://api.iconify.design/mdi:play.svg?color=white" alt="Play" class="w-3 h-3 inline"> Play';
                    dubBtn.disabled = false;
                    dubBtn.title = 'Play dubbed version';
                }
            }
        }

        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        function leaveCircle() {
            if (confirm('Are you sure you want to leave this circle?')) {
                socket.emit('leave_circle');
                
                // Remove from joined rooms
                let joinedRooms = JSON.parse(localStorage.getItem('joinedRooms') || '[]');
                joinedRooms = joinedRooms.filter(room => room.id !== roomId);
                localStorage.setItem('joinedRooms', JSON.stringify(joinedRooms));
                
                window.location.href = '/dashboard';
            }
        }

        function copyCircleId() {
            const titleElement = document.querySelector('h2[onclick="copyCircleId()"]');
            const originalText = titleElement.textContent;
            navigator.clipboard.writeText(roomId).then(() => {
                titleElement.textContent = 'Copied!';
                setTimeout(() => {
                    titleElement.textContent = originalText;
                }, 1000);
            }).catch(() => {
                alert('Circle ID: ' + roomId);
            });
        }

        function viewUserProfile(username) {
            window.open(`/user/${username}?user=${username}`, '_blank');
        }
        
        function translateMessage(messageId, text, sourceLanguage) {
            const translateBtn = event.target;
            translateBtn.innerHTML = '⏳ Translating...';
            translateBtn.disabled = true;
            
            socket.emit('translate_text', {
                message_id: messageId,
                text: text,
                source_language: sourceLanguage
            });
        }
        
        function updateMessageWithTranslation(data) {
            const messageDiv = document.querySelector(`[data-message-id="${data.message_id}"]`);
            if (messageDiv) {
                const originalTextDiv = messageDiv.querySelector('.original-text');
                const translateBtn = messageDiv.querySelector('button[onclick*="translateMessage"]');
                
                if (originalTextDiv && translateBtn) {
                    const translatedDiv = document.createElement('div');
                    translatedDiv.className = 'text-blue-200 mt-2 p-2 bg-blue-900/20 rounded-lg border border-blue-500/30';
                    
                    translatedDiv.innerHTML = `
                        <div class="text-xs text-blue-300 mb-1">🌍 Translated:</div>
                        <div>${data.translated_text}</div>
                    `;
                    
                    originalTextDiv.parentNode.insertBefore(translatedDiv, translateBtn.parentNode);
                    
                    translateBtn.innerHTML = '<img src="https://api.iconify.design/mdi:check.svg?color=white" alt="Translated" class="w-3 h-3"> Translated';
                    translateBtn.disabled = true;
                    translateBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
                    translateBtn.classList.add('bg-gray-600');
                }
            }
        }
        
        // Socket handlers for translation
        socket.on('translated_text', function(data) {
            updateMessageWithTranslation(data);
        });
        
        socket.on('translation_error', function(data) {
            const translateBtns = document.querySelectorAll('button[onclick*="translateMessage"]');
            translateBtns.forEach(btn => {
                if (btn.textContent.includes('Translating')) {
                    btn.innerHTML = '<img src="https://api.iconify.design/mdi:translate.svg?color=white" alt="Translate" class="w-3 h-3"> Translate';
                    btn.disabled = false;
                }
            });
            addStatusMessage(`❌ Translation failed: ${data.error}`);
        });
        
        socket.on('circle_language_updated', function(data) {
            addStatusMessage(`Language preference updated to ${document.getElementById('circleLanguage').selectedOptions[0].text}`);
        });

        // Load circle data if available
        const joinedRooms = JSON.parse(localStorage.getItem('joinedRooms') || '[]');
        const currentRoom = joinedRooms.find(room => room.id === roomId);
        if (currentRoom) {
            document.getElementById('circleName').textContent = currentRoom.name;
            if (currentRoom.image) {
                document.getElementById('circleAvatar').innerHTML = `<img src="${currentRoom.image}" alt="${currentRoom.name}" class="w-full h-full object-cover rounded-2xl">`;
            }
            // Show creation date
            if (currentRoom.joinedAt) {
                const date = new Date(currentRoom.joinedAt);
                if (!isNaN(date.getTime())) {
                    const createdDate = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long', 
                        day: 'numeric'
                    });
                    setTimeout(() => {
                        addStatusMessage(`Circle created on ${createdDate}`);
                    }, 1000);
                }
            }
        }
    </script>
</body>
</html>